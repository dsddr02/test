import{connect}from"cloudflare:sockets";let fakeUserID,fakeHostName,password="",proxyIP="",sub="",subConverter="SUBAPI.fxxk.dedyn.io",subConfig="https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/config/ACL4SSR_Online_Mini_MultiMode.ini",subProtocol="https",subEmoji="true",socks5Address="",parsedSocks5Address={},enableSocks=!1;const expire=4102329600;let proxyIPs,socks5s,sha224Password,go2Socks5s=["*ttvnw.net","*tapecontent.net","*cloudatacdn.com","*.loadshare.org"],addresses=[],addressesapi=[],addressescsv=[],DLS=8,remarkIndex=1,FileName="epeius",BotToken="",ChatID="",proxyhosts=[],proxyhostsURL="",RproxyIP="false",httpsPorts=["2053","2083","2087","2096","8443"];const regex=/^(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}|\[.*\]):?(\d+)?#?(.*)?$/;let proxyIPPool=[],path="/?ed=2560",link=[],banHosts=[atob("c3BlZWQuY2xvdWRmbGFyZS5jb20=")];export default{async fetch(t,e,n){try{const n=t.headers.get("User-Agent")||"null",s=n.toLowerCase();if(password=e.PASSWORD||e.pswd||e.UUID||e.uuid||e.TOKEN||password,!password)return new Response("请设置你的PASSWORD变量，或尝试重试部署，检查变量是否生效？",{status:404,headers:{"Content-Type":"text/plain;charset=utf-8"}});sha224Password=e.SHA224||e.SHA224PASS||sha224(password);const o=new Date;o.setHours(0,0,0,0);const r=Math.ceil(o.getTime()/1e3),a=await MD5MD5(`${password}${r}`);if(fakeUserID=[a.slice(0,8),a.slice(8,12),a.slice(12,16),a.slice(16,20),a.slice(20)].join("-"),fakeHostName=`${a.slice(6,9)}.${a.slice(13,19)}`,proxyIP=e.PROXYIP||e.proxyip||proxyIP,proxyIPs=await ADD(proxyIP),proxyIP=proxyIPs[Math.floor(Math.random()*proxyIPs.length)],socks5Address=e.SOCKS5||socks5Address,socks5s=await ADD(socks5Address),socks5Address=socks5s[Math.floor(Math.random()*socks5s.length)],socks5Address=socks5Address.split("//")[1]||socks5Address,e.GO2SOCKS5&&(go2Socks5s=await ADD(e.GO2SOCKS5)),e.CFPORTS&&(httpsPorts=await ADD(e.CFPORTS)),e.BAN&&(banHosts=await 整理(e.BAN)),socks5Address)try{parsedSocks5Address=socks5AddressParser(socks5Address),RproxyIP=e.RPROXYIP||"false",enableSocks=!0}catch(t){let n=t;console.log(n.toString()),RproxyIP=e.RPROXYIP||!proxyIP?"true":"false",enableSocks=!1}else RproxyIP=e.RPROXYIP||!proxyIP?"true":"false";const l=t.headers.get("Upgrade"),i=new URL(t.url);if(l&&"websocket"===l){if(socks5Address=i.searchParams.get("socks5")||socks5Address,new RegExp("/socks5=","i").test(i.pathname))socks5Address=i.pathname.split("5=")[1];else if((new RegExp("/socks://","i").test(i.pathname)||new RegExp("/socks5://","i").test(i.pathname))&&(socks5Address=i.pathname.split("://")[1].split("#")[0],socks5Address.includes("@"))){let t=socks5Address.split("@")[0];/^(?:[A-Z0-9+/]{4})*(?:[A-Z0-9+/]{2}==|[A-Z0-9+/]{3}=)?$/i.test(t)&&!t.includes(":")&&(t=atob(t)),socks5Address=`${t}@${socks5Address.split("@")[1]}`}if(socks5Address)try{parsedSocks5Address=socks5AddressParser(socks5Address),enableSocks=!0}catch(t){let e=t;console.log(e.toString()),enableSocks=!1}else enableSocks=!1;return i.searchParams.has("proxyip")?(proxyIP=i.searchParams.get("proxyip"),enableSocks=!1):new RegExp("/proxyip=","i").test(i.pathname)?(proxyIP=i.pathname.toLowerCase().split("/proxyip=")[1],enableSocks=!1):new RegExp("/proxyip.","i").test(i.pathname)?(proxyIP=`proxyip.${i.pathname.toLowerCase().split("/proxyip.")[1]}`,enableSocks=!1):new RegExp("/pyip=","i").test(i.pathname)&&(proxyIP=i.pathname.toLowerCase().split("/pyip=")[1],enableSocks=!1),await 特洛伊OverWSHandler(t)}switch(e.ADD&&(addresses=await ADD(e.ADD)),e.ADDAPI&&(addressesapi=await ADD(e.ADDAPI)),e.ADDCSV&&(addressescsv=await ADD(e.ADDCSV)),DLS=Number(e.DLS)||DLS,remarkIndex=Number(e.CSVREMARK)||remarkIndex,BotToken=e.TGTOKEN||BotToken,ChatID=e.TGID||ChatID,FileName=e.SUBNAME||FileName,subEmoji=e.SUBEMOJI||e.EMOJI||subEmoji,"0"==subEmoji&&(subEmoji="false"),e.LINK&&(link=await ADD(e.LINK)),sub=e.SUB||sub,subConverter=e.SUBAPI||subConverter,subConverter.includes("http://")?(subConverter=subConverter.split("//")[1],subProtocol="http"):subConverter=subConverter.split("//")[1]||subConverter,subConfig=e.SUBCONFIG||subConfig,i.searchParams.has("sub")&&""!==i.searchParams.get("sub")&&(sub=i.searchParams.get("sub")),i.searchParams.has("proxyip")?(path=`/?ed=2560&proxyip=${i.searchParams.get("proxyip")}`,RproxyIP="false"):i.searchParams.has("socks5")?(path=`/?ed=2560&socks5=${i.searchParams.get("socks5")}`,RproxyIP="false"):i.searchParams.has("socks")&&(path=`/?ed=2560&socks5=${i.searchParams.get("socks")}`,RproxyIP="false"),i.pathname){case"/":return e.URL302?Response.redirect(e.URL302,302):e.URL?await proxyURL(e.URL,i):new Response(JSON.stringify(t.cf,null,4),{status:200,headers:{"content-type":"application/json"}});case`/${fakeUserID}`:const o=await get特洛伊Config(password,t.headers.get("Host"),sub,"CF-Workers-SUB",RproxyIP,i,e);return new Response(`${o}`,{status:200});case`/${password}/edit`:return await KV(t,e);case`/${password}`:await sendMessage(`#获取订阅 ${FileName}`,t.headers.get("CF-Connecting-IP"),`UA: ${n}</tg-spoiler>\n域名: ${i.hostname}\n<tg-spoiler>入口: ${i.pathname+i.search}</tg-spoiler>`);const r=await get特洛伊Config(password,t.headers.get("Host"),sub,n,RproxyIP,i,e),a=Date.now(),l=new Date(a);l.setHours(0,0,0,0);const c=Math.floor((a-l.getTime())/864e5*24*1099511627776/2);let d=c,p=c,u=26388279066624;return s&&(s.includes("mozilla")||s.includes("subconverter"))?new Response(`<div style="font-size:13px;">${r}</div>`,{status:200,headers:{"Content-Type":"text/html;charset=utf-8","Profile-Update-Interval":"6","Subscription-Userinfo":`upload=${d}; download=${p}; total=${u}; expire=${expire}`,"Cache-Control":"no-store"}}):new Response(`${r}`,{status:200,headers:{"Content-Disposition":`attachment; filename=${FileName}; filename*=utf-8''${encodeURIComponent(FileName)}`,"Content-Type":"text/plain;charset=utf-8","Profile-Update-Interval":"6","Subscription-Userinfo":`upload=${d}; download=${p}; total=${u}; expire=${expire}`}});default:return e.URL302?Response.redirect(e.URL302,302):e.URL?await proxyURL(e.URL,i):new Response("不用怀疑！你PASSWORD就是错的！！！",{status:404})}}catch(t){return new Response(t.toString())}}};async function 特洛伊OverWSHandler(t){const e=new WebSocketPair,[n,s]=Object.values(e);s.accept();let o="",r="";const log=(t,e)=>{console.log(`[${o}:${r}] ${t}`,e||"")},a=t.headers.get("sec-websocket-protocol")||"",l=makeReadableWebSocketStream(s,a,log);let i={value:null};return l.pipeTo(new WritableStream({async write(t,e){if(i.value){const e=i.value.writable.getWriter();return await e.write(t),void e.releaseLock()}const{hasError:n,message:a,portRemote:l=443,addressRemote:c="",rawClientData:d,addressType:p}=await parse特洛伊Header(t);if(o=c,r=`${l}--${Math.random()} tcp`,n)throw new Error(a);if(banHosts.includes(c))throw new Error(`黑名单关闭 TCP 出站连接 ${c}:${l}`);log(`处理 TCP 出站连接 ${c}:${l}`),handleTCPOutBound(i,c,l,d,s,log,p)},close(){log("readableWebSocketStream is closed")},abort(t){log("readableWebSocketStream is aborted",JSON.stringify(t))}})).catch((t=>{log("readableWebSocketStream pipeTo error",t)})),new Response(null,{status:101,webSocket:n})}async function parse特洛伊Header(t){if(t.byteLength<56)return{hasError:!0,message:"invalid data"};if(13!==new Uint8Array(t.slice(56,57))[0]||10!==new Uint8Array(t.slice(57,58))[0])return{hasError:!0,message:"invalid header format (missing CR LF)"};if((new TextDecoder).decode(t.slice(0,56))!==sha224Password)return{hasError:!0,message:"invalid password"};const e=t.slice(58);if(e.byteLength<6)return{hasError:!0,message:"invalid SOCKS5 request data"};const n=new DataView(e);if(1!==n.getUint8(0))return{hasError:!0,message:"unsupported command, only TCP (CONNECT) is allowed"};const s=n.getUint8(1);let o=0,r=2,a="";switch(s){case 1:o=4,a=new Uint8Array(e.slice(r,r+o)).join(".");break;case 3:o=new Uint8Array(e.slice(r,r+1))[0],r+=1,a=(new TextDecoder).decode(e.slice(r,r+o));break;case 4:o=16;const t=new DataView(e.slice(r,r+o)),n=[];for(let e=0;e<8;e++)n.push(t.getUint16(2*e).toString(16));a=n.join(":");break;default:return{hasError:!0,message:`invalid addressType is ${s}`}}if(!a)return{hasError:!0,message:`address is empty, addressType is ${s}`};const l=r+o,i=e.slice(l,l+2);return{hasError:!1,addressRemote:a,portRemote:new DataView(i).getUint16(0),rawClientData:e.slice(l+4),addressType:s}}async function handleTCPOutBound(t,e,n,s,o,r,a){async function connectAndWrite(e,n,o=!1){r(`connected to ${e}:${n}`);const l=o?await socks5Connect(a,e,n,r):connect({hostname:e,port:n});t.value=l;const i=l.writable.getWriter();return await i.write(s),i.releaseLock(),l}let l=!1;go2Socks5s.length>0&&enableSocks&&(l=await async function(t){return!(!go2Socks5s.includes(atob("YWxsIGlu"))&&!go2Socks5s.includes(atob("Kg==")))||go2Socks5s.some((e=>{let n=e.replace(/\*/g,".*");return new RegExp(`^${n}$`,"i").test(t)}))}(e));let i=await connectAndWrite(e,n,l);remoteSocketToWS(i,o,(async function(){enableSocks?i=await connectAndWrite(e,n,!0):(proxyIP&&""!=proxyIP?proxyIP.includes("]:")?(n=proxyIP.split("]:")[1]||n,proxyIP=proxyIP.split("]:")[0]||proxyIP):2===proxyIP.split(":").length&&(n=proxyIP.split(":")[1]||n,proxyIP=proxyIP.split(":")[0]||proxyIP):proxyIP=atob("UFJPWFlJUC50cDEuZnh4ay5kZWR5bi5pbw=="),proxyIP.includes(".tp")&&(n=proxyIP.split(".tp")[1].split(".")[0]||n),i=await connectAndWrite(proxyIP||e,n)),i.closed.catch((t=>{console.log("retry tcpSocket closed error",t)})).finally((()=>{safeCloseWebSocket(o)})),remoteSocketToWS(i,o,null,r)}),r)}function makeReadableWebSocketStream(t,e,n){let s=!1;return new ReadableStream({start(o){t.addEventListener("message",(t=>{if(s)return;const e=t.data;o.enqueue(e)})),t.addEventListener("close",(()=>{safeCloseWebSocket(t),s||o.close()})),t.addEventListener("error",(t=>{n("webSocketServer error"),o.error(t)}));const{earlyData:r,error:a}=base64ToArrayBuffer(e);a?o.error(a):r&&o.enqueue(r)},pull(t){},cancel(e){s||(n(`readableStream was canceled, due to ${e}`),s=!0,safeCloseWebSocket(t))}})}async function remoteSocketToWS(t,e,n,s){let o=!1;await t.readable.pipeTo(new WritableStream({start(){},async write(t,n){o=!0,e.readyState!==WS_READY_STATE_OPEN&&n.error("webSocket connection is not open"),e.send(t)},close(){s(`remoteSocket.readable is closed, hasIncomingData: ${o}`)},abort(t){console.error("remoteSocket.readable abort",t)}})).catch((t=>{console.error("remoteSocketToWS error:",t.stack||t),safeCloseWebSocket(e)})),!1===o&&n&&(s("retry"),n())}function base64ToArrayBuffer(t){if(!t)return{earlyData:void 0,error:null};try{t=t.replace(/-/g,"+").replace(/_/g,"/");const e=atob(t);return{earlyData:Uint8Array.from(e,(t=>t.charCodeAt(0))).buffer,error:null}}catch(t){return{earlyData:void 0,error:t}}}let WS_READY_STATE_OPEN=1,WS_READY_STATE_CLOSING=2;function safeCloseWebSocket(t){try{t.readyState!==WS_READY_STATE_OPEN&&t.readyState!==WS_READY_STATE_CLOSING||t.close()}catch(t){console.error("safeCloseWebSocket error",t)}}function revertFakeInfo(t,e,n,s){return s&&(t=atob(t)),t=t.replace(new RegExp(fakeUserID,"g"),e).replace(new RegExp(fakeHostName,"g"),n),s&&(t=btoa(t)),t}async function MD5MD5(t){const e=new TextEncoder,n=await crypto.subtle.digest("MD5",e.encode(t)),s=Array.from(new Uint8Array(n)).map((t=>t.toString(16).padStart(2,"0"))).join(""),o=await crypto.subtle.digest("MD5",e.encode(s.slice(7,27)));return Array.from(new Uint8Array(o)).map((t=>t.toString(16).padStart(2,"0"))).join("").toLowerCase()}async function ADD(t){var e=t.replace(/[	|"'\r\n]+/g,",").replace(/,+/g,",");","==e.charAt(0)&&(e=e.slice(1)),","==e.charAt(e.length-1)&&(e=e.slice(0,e.length-1));return e.split(",")}async function proxyURL(t,e){const n=await ADD(t),s=n[Math.floor(Math.random()*n.length)];let o=new URL(s);console.log(o);let r=o.protocol.slice(0,-1)||"https",a=o.hostname,l=o.pathname,i=o.search;"/"==l.charAt(l.length-1)&&(l=l.slice(0,-1)),l+=e.pathname;let c=`${r}://${a}${l}${i}`,d=await fetch(c),p=new Response(d.body,{status:d.status,statusText:d.statusText,headers:d.headers});return p.headers.set("X-New-URL",c),p}function 配置信息(t,e){const n=atob("dHJvamFu"),s=FileName;let o=e;const r=e,a=path;const l=e,i="randomized";return[`${n}://${encodeURIComponent(t)}@${o}:443?security=tls&sni=${l}&alpn=h3&fp=${i}&allowInsecure=1&type=ws&host=${r}&path=${encodeURIComponent(a)}#${encodeURIComponent(s)}`,`- {name: ${s}, server: ${o}, port: 443, udp: false, client-fingerprint: ${i}, type: ${n}, password: ${t}, sni: ${l}, alpn: [h3], skip-cert-verify: true, network: ws, ws-opts: {path: "${a}", headers: {Host: ${r}}}}`]}let subParams=["sub","base64","b64","clash","singbox","sb","surge"];const cmad=decodeURIComponent(atob("dGVsZWdyYW0lMjAlRTQlQkElQTQlRTYlQjUlODElRTclQkUlQTQlMjAlRTYlOEElODAlRTYlOUMlQUYlRTUlQTQlQTclRTQlQkQlQUMlN0UlRTUlOUMlQTglRTclQkElQkYlRTUlOEYlOTElRTclODklOEMhJTNDYnIlM0UKJTNDYSUyMGhyZWYlM0QlMjdodHRwcyUzQSUyRiUyRnQubWUlMkZDTUxpdXNzc3MlMjclM0VodHRwcyUzQSUyRiUyRnQubWUlMkZDTUxpdXNzc3MlM0MlMkZhJTNFJTNDYnIlM0UKLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tJTNDYnIlM0UKZ2l0aHViJTIwJUU5JUExJUI5JUU3JTlCJUFFJUU1JTlDJUIwJUU1JTlEJTgwJTIwU3RhciFTdGFyIVN0YXIhISElM0NiciUzRQolM0NhJTIwaHJlZiUzRCUyN2h0dHBzJTNBJTJGJTJGZ2l0aHViLmNvbSUyRmNtbGl1JTJGZXBlaXVzJTI3JTNFaHR0cHMlM0ElMkYlMkZnaXRodWIuY29tJTJGY21saXUlMkZlcGVpdXMlM0MlMkZhJTNFJTNDYnIlM0UKLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tJTNDYnIlM0UKJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIzJTIz"));async function get特洛伊Config(t,e,n,s,o,r,a){if(n){const t=n.match(/^(?:https?:\/\/)?([^\/]+)/);t&&(n=t[1]);const e=await ADD(n);e.length>1&&(n=e[0])}else{if(a.KV){await 迁移地址列表(a);const t=await a.KV.get("ADD.txt");if(t){const e=await ADD(t),n={"接口地址":new Set,"链接地址":new Set,"优选地址":new Set};for(const t of e)t.startsWith("https://")?n.接口地址.add(t):t.includes("://")?n.链接地址.add(t):n.优选地址.add(t);addressesapi=[...n.接口地址],link=[...n.链接地址],addresses=[...n.优选地址]}}if(addresses.length+addressesapi.length+addressescsv.length==0){let t=["103.21.244.0/23","104.16.0.0/13","104.24.0.0/14","172.64.0.0/14","103.21.244.0/23","104.16.0.0/14","104.24.0.0/15","141.101.64.0/19","172.64.0.0/14","188.114.96.0/21","190.93.240.0/21"];addresses=addresses.concat("127.0.0.1:1234#CFnat"),addresses=addresses.concat(t.map((t=>function(t){const[e,n]=t.split("/"),s=e.split(".").map(Number),o=32-parseInt(n,10),r=Math.pow(2,o)-1,a=Math.floor(Math.random()*r);return s.map(((t,e)=>e<2?t:2===e?(t&255<<o-8)+(a>>8&255):(t&255<<o)+(255&a))).join(".")}(t)+"#CF随机节点")))}}const l=s.toLowerCase(),i=配置信息(t,e),c=i[0],d=i[1];let p="";if(e.includes(".workers.dev")){if(proxyhostsURL&&(!proxyhosts||0==proxyhosts.length))try{const t=await fetch(proxyhostsURL);if(!t.ok)return void console.error("获取地址时出错:",t.status,t.statusText);const e=await t.text(),n=e.split("\n").filter((t=>""!==t.trim()));proxyhosts=proxyhosts.concat(n)}catch(t){}0!=proxyhosts.length&&(p=proxyhosts[Math.floor(Math.random()*proxyhosts.length)]+"/")}if(l.includes("mozilla")&&!subParams.some((t=>r.searchParams.has(t)))){let l=`Surge订阅地址:<br><a href="javascript:void(0)" onclick="copyToClipboard('https://${p}${e}/${t}?surge','qrcode_4')" style="color:blue;text-decoration:underline;cursor:pointer;">https://${p}${e}/${t}?surge</a><br><div id="qrcode_4" style="margin: 10px 10px 10px 10px;"></div>`;e.includes(".workers.dev")&&(l="Surge订阅必须绑定自定义域");const i=socks5s.map((t=>t.includes("@")?t.split("@")[1]:t.includes("//")?t.split("//")[1]:t));let u="";go2Socks5s.length>0&&enableSocks&&(u=`${decodeURIComponent("SOCKS5%EF%BC%88%E7%99%BD%E5%90%8D%E5%8D%95%EF%BC%89%3A%20")}`,go2Socks5s.includes(atob("YWxsIGlu"))||go2Socks5s.includes(atob("Kg=="))?u+=`${decodeURIComponent("%E6%89%80%E6%9C%89%E6%B5%81%E9%87%8F")}<br>`:u+=`<br>&nbsp;&nbsp;${go2Socks5s.join("<br>&nbsp;&nbsp;")}<br>`);let U="";if(n)U+=enableSocks?`CFCDN（访问方式）: Socks5<br>&nbsp;&nbsp;${i.join("<br>&nbsp;&nbsp;")}<br>${u}`:proxyIP&&""!=proxyIP?`CFCDN（访问方式）: ProxyIP<br>&nbsp;&nbsp;${proxyIPs.join("<br>&nbsp;&nbsp;")}<br>`:"true"==o?"CFCDN（访问方式）: 自动获取ProxyIP<br>":"CFCDN（访问方式）: 无法访问, 需要您设置 proxyIP/PROXYIP ！！！<br>",U+=`<br>SUB（优选订阅生成器）: ${n}`;else{U+=enableSocks?`CFCDN（访问方式）: Socks5<br>&nbsp;&nbsp;${i.join("<br>&nbsp;&nbsp;")}<br>${u}`:proxyIP&&""!=proxyIP?`CFCDN（访问方式）: ProxyIP<br>&nbsp;&nbsp;${proxyIPs.join("<br>&nbsp;&nbsp;")}<br>`:"CFCDN（访问方式）: 无法访问, 需要您设置 proxyIP/PROXYIP ！！！<br>";let t="";a.KV&&(t=` <a href='${r.pathname}/edit'>编辑优选列表</a>`),U+=`<br>您的订阅内容由 内置 addresses/ADD* 参数变量提供${t}<br>`,addresses.length>0&&(U+=`ADD（TLS优选域名&IP）: <br>&nbsp;&nbsp;${addresses.join("<br>&nbsp;&nbsp;")}<br>`),addressesapi.length>0&&(U+=`ADDAPI（TLS优选域名&IP 的 API）: <br>&nbsp;&nbsp;${addressesapi.join("<br>&nbsp;&nbsp;")}<br>`),addressescsv.length>0&&(U+=`ADDCSV（IPTest测速csv文件 限速 ${DLS} ）: <br>&nbsp;&nbsp;${addressescsv.join("<br>&nbsp;&nbsp;")}<br>`)}return`\n\t\t\t################################################################<br>\n\t\t\tSubscribe / sub 订阅地址, 点击链接自动 <strong>复制订阅链接</strong> 并 <strong>生成订阅二维码</strong> <br>\n\t\t\t---------------------------------------------------------------<br>\n\t\t\t自适应订阅地址:<br>\n\t\t\t<a href="javascript:void(0)" onclick="copyToClipboard('https://${p}${e}/${t}?sub','qrcode_0')" style="color:blue;text-decoration:underline;cursor:pointer;">https://${p}${e}/${t}</a><br>\n\t\t\t<div id="qrcode_0" style="margin: 10px 10px 10px 10px;"></div>\n\t\t\tBase64订阅地址:<br>\n\t\t\t<a href="javascript:void(0)" onclick="copyToClipboard('https://${p}${e}/${t}?b64','qrcode_1')" style="color:blue;text-decoration:underline;cursor:pointer;">https://${p}${e}/${t}?b64</a><br>\n\t\t\t<div id="qrcode_1" style="margin: 10px 10px 10px 10px;"></div>\n\t\t\tclash订阅地址:<br>\n\t\t\t<a href="javascript:void(0)" onclick="copyToClipboard('https://${p}${e}/${t}?clash','qrcode_2')" style="color:blue;text-decoration:underline;cursor:pointer;">https://${p}${e}/${t}?clash</a><br>\n\t\t\t<div id="qrcode_2" style="margin: 10px 10px 10px 10px;"></div>\n\t\t\tsingbox订阅地址:<br>\n\t\t\t<a href="javascript:void(0)" onclick="copyToClipboard('https://${p}${e}/${t}?sb','qrcode_3')" style="color:blue;text-decoration:underline;cursor:pointer;">https://${p}${e}/${t}?sb</a><br>\n\t\t\t<div id="qrcode_3" style="margin: 10px 10px 10px 10px;"></div>\n\t\t\t${l}\n\t\t\t<strong><a href="javascript:void(0);" id="noticeToggle" onclick="toggleNotice()">实用订阅技巧∨</a></strong><br>\n\t\t\t\t<div id="noticeContent" class="notice-content" style="display: none;">\n\t\t\t\t\t<strong>1.</strong> 如您使用的是 PassWall、SSR+ 等路由插件，推荐使用 <strong>Base64订阅地址</strong> 进行订阅；<br>\n\t\t\t\t\t<br>\n\t\t\t\t\t<strong>2.</strong> 快速切换 <a href='${atob("aHR0cHM6Ly9naXRodWIuY29tL2NtbGl1L1dvcmtlclZsZXNzMnN1Yg==")}'>优选订阅生成器</a> 至：sub.google.com，您可将"?sub=sub.google.com"参数添加到链接末尾，例如：<br>\n\t\t\t\t\t&nbsp;&nbsp;https://${p}${e}/${t}<strong>?sub=sub.google.com</strong><br>\n\t\t\t\t\t<br>\n\t\t\t\t\t<strong>3.</strong> 快速更换 PROXYIP 至：proxyip.fxxk.dedyn.io:443，您可将"?proxyip=proxyip.fxxk.dedyn.io:443"参数添加到链接末尾，例如：<br>\n\t\t\t\t\t&nbsp;&nbsp; https://${p}${e}/${t}<strong>?proxyip=proxyip.fxxk.dedyn.io:443</strong><br>\n\t\t\t\t\t<br>\n\t\t\t\t\t<strong>4.</strong> 快速更换 SOCKS5 至：user:password@127.0.0.1:1080，您可将"?socks5=user:password@127.0.0.1:1080"参数添加到链接末尾，例如：<br>\n\t\t\t\t\t&nbsp;&nbsp;https://${p}${e}/${t}<strong>?socks5=user:password@127.0.0.1:1080</strong><br>\n\t\t\t\t\t<br>\n\t\t\t\t\t<strong>5.</strong> 如需指定多个参数则需要使用'&'做间隔，例如：<br>\n\t\t\t\t\t&nbsp;&nbsp;https://${p}${e}/${t}?sub=sub.google.com<strong>&</strong>proxyip=proxyip.fxxk.dedyn.io<br>\n\t\t\t\t</div>\n\t\t\t<script src="https://cdn.jsdelivr.net/npm/@keeex/qrcodejs-kx@1.0.2/qrcode.min.js"><\/script>\n\t\t\t<script>\n\t\t\tfunction copyToClipboard(text, qrcode) {\n\t\t\t\tnavigator.clipboard.writeText(text).then(() => {\n\t\t\t\t\talert('已复制到剪贴板');\n\t\t\t\t}).catch(err => {\n\t\t\t\t\tconsole.error('复制失败:', err);\n\t\t\t\t});\n\t\t\t\tconst qrcodeDiv = document.getElementById(qrcode);\n\t\t\t\tqrcodeDiv.innerHTML = '';\n\t\t\t\tnew QRCode(qrcodeDiv, {\n\t\t\t\t\ttext: text,\n\t\t\t\t\twidth: 220, // 调整宽度\n\t\t\t\t\theight: 220, // 调整高度\n\t\t\t\t\tcolorDark: "#000000", // 二维码颜色\n\t\t\t\t\tcolorLight: "#ffffff", // 背景颜色\n\t\t\t\t\tcorrectLevel: QRCode.CorrectLevel.Q, // 设置纠错级别\n\t\t\t\t\tscale: 1 // 调整像素颗粒度\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tfunction toggleNotice() {\n\t\t\t\tconst noticeContent = document.getElementById('noticeContent');\n\t\t\t\tconst noticeToggle = document.getElementById('noticeToggle');\n\t\t\t\tif (noticeContent.style.display === 'none') {\n\t\t\t\t\tnoticeContent.style.display = 'block';\n\t\t\t\t\tnoticeToggle.textContent = '实用订阅技巧∧';\n\t\t\t\t} else {\n\t\t\t\t\tnoticeContent.style.display = 'none'; \n\t\t\t\t\tnoticeToggle.textContent = '实用订阅技巧∨';\n\t\t\t\t}\n\t\t\t}\n\t\t\t<\/script>\n\t\t\t---------------------------------------------------------------<br>\n\t\t\t################################################################<br>\n\t\t\t${FileName} 配置信息<br>\n\t\t\t---------------------------------------------------------------<br>\n\t\t\tHOST: ${e}<br>\n\t\t\tPASSWORD: ${t}<br>\n\t\t\tSHA224: ${sha224Password}<br>\n\t\t\tFAKEPASS: ${fakeUserID}<br>\n\t\t\tUA: ${s}<br>\n\t\t\t<br>\n\t\t\t${U}<br>\n\t\t\tSUBAPI（订阅转换后端）: ${subProtocol}://${subConverter}<br>\n\t\t\tSUBCONFIG（订阅转换配置文件）: ${subConfig}<br>\n\t\t\t---------------------------------------------------------------<br>\n\t\t\t################################################################<br>\n\t\t\tv2ray<br>\n\t\t\t---------------------------------------------------------------<br>\n\t\t\t<a href="javascript:void(0)" onclick="copyToClipboard('${c}','qrcode_v2ray')" style="color:blue;text-decoration:underline;cursor:pointer;">${c}</a><br>\n\t\t\t<div id="qrcode_v2ray" style="margin: 10px 10px 10px 10px;"></div>\n\t\t\t---------------------------------------------------------------<br>\n\t\t\t################################################################<br>\n\t\t\tclash-meta<br>\n\t\t\t---------------------------------------------------------------<br>\n\t\t\t${d}<br>\n\t\t\t---------------------------------------------------------------<br>\n\t\t\t################################################################<br>\n\t\t\t${cmad}\n\t\t\t`}{if("function"!=typeof fetch)return"Error: fetch is not available in this environment.";fakeHostName=e.includes(".workers.dev")?`${fakeHostName}.workers.dev`:`${fakeHostName}.xyz`;let s=`https://${n}/sub?host=${fakeHostName}&pw=${fakeUserID}&password=${fakeUserID+atob("JmVwZWl1cz1jbWxpdSZwcm94eWlwPQ==")+o}&path=${encodeURIComponent(path)}`,a=!0,i=[],c=[];if(!n||""==n){if(e.includes("workers.dev")){if(proxyhostsURL&&(!proxyhosts||0==proxyhosts.length))try{const t=await fetch(proxyhostsURL);if(!t.ok)return void console.error("获取地址时出错:",t.status,t.statusText);const e=await t.text(),n=e.split("\n").filter((t=>""!==t.trim()));proxyhosts=proxyhosts.concat(n)}catch(t){console.error("获取地址时出错:",t)}proxyhosts=[...new Set(proxyhosts)]}i=await getAddressesapi(addressesapi),c=await getAddressescsv("TRUE"),s=`https://${e}/${fakeUserID+r.search}`}l.includes("CF-Workers-SUB".toLowerCase())||(l.includes("clash")&&!l.includes("nekobox")||r.searchParams.has("clash")?(s=`${subProtocol}://${subConverter}/sub?target=clash&url=${encodeURIComponent(s)}&insert=false&config=${encodeURIComponent(subConfig)}&emoji=${subEmoji}&list=false&tfo=false&scv=true&fdn=false&sort=false&new_name=true`,a=!1):l.includes("sing-box")||l.includes("singbox")||r.searchParams.has("singbox")||r.searchParams.has("sb")?(s=`${subProtocol}://${subConverter}/sub?target=singbox&url=${encodeURIComponent(s)}&insert=false&config=${encodeURIComponent(subConfig)}&emoji=${subEmoji}&list=false&tfo=false&scv=true&fdn=false&sort=false&new_name=true`,a=!1):(l.includes("surge")||r.searchParams.has("surge"))&&(s=`${subProtocol}://${subConverter}/sub?target=surge&ver=4&url=${encodeURIComponent(s)}&insert=false&config=${encodeURIComponent(subConfig)}&emoji=${subEmoji}&list=false&xudp=false&udp=false&tfo=false&expand=true&scv=true&fdn=false`,a=!1));try{let o;if(n&&""!=n||1!=a){const t=await fetch(s,{headers:{"User-Agent":atob("Q0YtV29ya2Vycy1lcGVpdXMvY21saXU=")}});o=await t.text()}else o=await subAddresses(fakeHostName,fakeUserID,l,i,c);return r.pathname==`/${fakeUserID}`||(o=revertFakeInfo(o,t,e,a),(l.includes("surge")||r.searchParams.has("surge"))&&(o=surge(o,`https://${e}/${t}?surge`))),o}catch(t){return console.error("Error fetching content:",t),`Error fetching content: ${t.message}`}}}async function sendMessage(t,e,n=""){if(""!==BotToken&&""!==ChatID){let s="";const o=await fetch(`http://ip-api.com/json/${e}?lang=zh-CN`);if(200==o.status){const r=await o.json();s=`${t}\nIP: ${e}\n国家: ${r.country}\n<tg-spoiler>城市: ${r.city}\n组织: ${r.org}\nASN: ${r.as}\n${n}`}else s=`${t}\nIP: ${e}\n<tg-spoiler>${n}`;let r="https://api.telegram.org/bot"+BotToken+"/sendMessage?chat_id="+ChatID+"&parse_mode=HTML&text="+encodeURIComponent(s);return fetch(r,{method:"get",headers:{Accept:"text/html,application/xhtml+xml,application/xml;","Accept-Encoding":"gzip, deflate, br","User-Agent":"Mozilla/5.0 Chrome/90.0.4430.72"}})}}async function socks5Connect(t,e,n,s){const{username:o,password:r,hostname:a,port:l}=parsedSocks5Address,i=connect({hostname:a,port:l}),c=new Uint8Array([5,2,0,2]),d=i.writable.getWriter();await d.write(c),s("sent socks greeting");const p=i.readable.getReader(),u=new TextEncoder;let U,b=(await p.read()).value;if(5!==b[0])return void s(`socks server version error: ${b[0]} expected: 5`);if(255===b[1])return void s("no acceptable methods");if(2===b[1]){if(s("socks server needs auth"),!o||!r)return void s("please provide username/password");const t=new Uint8Array([1,o.length,...u.encode(o),r.length,...u.encode(r)]);if(await d.write(t),b=(await p.read()).value,1!==b[0]||0!==b[1])return void s("fail to auth socks server")}switch(t){case 1:U=new Uint8Array([1,...e.split(".").map(Number)]);break;case 3:U=new Uint8Array([3,e.length,...u.encode(e)]);break;case 4:U=new Uint8Array([4,...e.split(":").flatMap((t=>[parseInt(t.slice(0,2),16),parseInt(t.slice(2),16)]))]);break;default:return void s(`invild  addressType is ${t}`)}const y=new Uint8Array([5,1,0,...U,n>>8,255&n]);if(await d.write(y),s("sent socks request"),b=(await p.read()).value,0===b[1])return s("socks connection opened"),d.releaseLock(),p.releaseLock(),i;s("fail to open socks connection")}function socks5AddressParser(t){let e,n,s,o,[r,a]=t.split("@").reverse();if(a){const t=a.split(":");if(2!==t.length)throw new Error("Invalid SOCKS address format");[e,n]=t}const l=r.split(":");if(o=Number(l.pop()),isNaN(o))throw new Error("Invalid SOCKS address format");s=l.join(":");if(s.includes(":")&&!/^\[.*\]$/.test(s))throw new Error("Invalid SOCKS address format");return{username:e,password:n,hostname:s,port:o}}function isValidIPv4(t){return/^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/.test(t)}function subAddresses(t,e,n,s,o){addresses=addresses.concat(s),addresses=addresses.concat(o);const r=[...new Set(addresses)].map((s=>{let o="-1",r=s;const a=r.match(regex);if(a)s=a[1],o=a[2]||o,r=a[3]||s;else{if(s.includes(":")&&s.includes("#")){const t=s.split(":");s=t[0];const e=t[1].split("#");o=e[0],r=e[1]}else if(s.includes(":")){const t=s.split(":");s=t[0],o=t[1]}else if(s.includes("#")){const t=s.split("#");s=t[0],r=t[1]}r.includes(":")&&(r=r.split(":")[0])}const l=["2053","2083","2087","2096","8443"];if(!isValidIPv4(s)&&"-1"==o)for(let t of l)if(s.includes(t)){o=t;break}"-1"==o&&(o="443");let i=t,c=path,d="";proxyhosts.length>0&&i.includes(".workers.dev")&&(c=`/${i}${c}`,i=proxyhosts[Math.floor(Math.random()*proxyhosts.length)],d=" 已启用临时域名中转服务，请尽快绑定自定义域！");const p=proxyIPPool.find((t=>t.includes(s)));p&&(c+=`&proxyip=${p}`);let u=e;n.includes("subconverter")||(u=encodeURIComponent(e));return`${atob("dHJvamFu")}://${u}@${s}:${o}?security=tls&sni=${i}&fp=randomized&type=ws&host=${i}&path=${encodeURIComponent(c)}#${encodeURIComponent(r+d)}`})).join("\n");let a=r;return link.length>0&&(a+="\n"+link.join("\n")),btoa(a)}async function getAddressesapi(t){if(!t||0===t.length)return[];let e="";const n=new AbortController,s=setTimeout((()=>{n.abort()}),2e3);try{const s=await Promise.allSettled(t.map((t=>fetch(t,{method:"get",headers:{Accept:"text/html,application/xhtml+xml,application/xml;","User-Agent":atob("Q0YtV29ya2Vycy1lcGVpdXMvY21saXU=")},signal:n.signal}).then((t=>t.ok?t.text():Promise.reject())))));for(const[n,o]of s.entries())if("fulfilled"===o.status){const s=await o.value,r=s.split(/\r?\n/);let a="",l="443";if(r[0].split(",").length>3){const s=t[n].match(/id=([^&]*)/);s&&(a=s[1]);const o=t[n].match(/port=([^&]*)/);o&&(l=o[1]);for(let s=1;s<r.length;s++){const o=r[s].split(",")[0];o&&(e+=`${o}:${l}${a?`#${a}`:""}\n`,t[n].includes("proxyip=true")&&proxyIPPool.push(`${o}:${l}`))}}else t[n].includes("proxyip=true")&&(proxyIPPool=proxyIPPool.concat((await ADD(s)).map((t=>{const e=t.split("#")[0]||t;if(!e.includes(":"))return`${e}:443`;{const t=e.split(":")[1];if(!httpsPorts.includes(t))return e}return null})).filter(Boolean))),e+=s+"\n"}}catch(t){console.error(t)}finally{clearTimeout(s)}return await ADD(e)}async function getAddressescsv(t){if(!addressescsv||0===addressescsv.length)return[];let e=[];for(const n of addressescsv)try{const s=await fetch(n);if(!s.ok){console.error("获取CSV地址时出错:",s.status,s.statusText);continue}const o=await s.text();let r;r=o.includes("\r\n")?o.split("\r\n"):o.split("\n");const a=r[0].split(",").indexOf("TLS"),l=0,i=1,c=a+remarkIndex;if(-1===a){console.error("CSV文件缺少必需的字段");continue}for(let s=1;s<r.length;s++){const o=r[s].split(","),d=o.length-1;if(o[a].toUpperCase()===t&&parseFloat(o[d])>DLS){const t=o[l],s=o[i],r=`${t}:${s}#${o[c]}`;e.push(r),n.includes("proxyip=true")&&"true"==o[a].toUpperCase()&&!httpsPorts.includes(s)&&proxyIPPool.push(`${t}:${s}`)}}}catch(t){console.error("获取CSV地址时出错:",t);continue}return e}function surge(t,e){let n;n=t.includes("\r\n")?t.split("\r\n"):t.split("\n");let s="";for(let t of n)if(t.includes(atob("PSB0cm9qYW4s"))){const e=t.split("sni=")[1].split(",")[0],n="skip-cert-verify=true, tfo=false, udp-relay=false",o=`skip-cert-verify=true, ws=true, ws-path=${path}, ws-headers=Host:"${e}", tfo=false, udp-relay=false`;s+=t.replace(new RegExp(n,"g"),o).replace("[","").replace("]","")+"\n"}else s+=t+"\n";return s=`#!MANAGED-CONFIG ${e} interval=86400 strict=false`+s.substring(s.indexOf("\n")),s}
/**
 * [js-sha256]{@link https://github.com/emn178/js-sha256}
 * 
 * @version 0.11.0 (modified by cmliu)
 * @description 本代码基于 js-sha256 项目改编，添加了 SHA-224 哈希算法的实现。
 * @author Chen, Yi-Cyuan [emn178@gmail.com], modified by cmliu
 * @copyright Chen, Yi-Cyuan 2014-2024
 * @license MIT
 * 
 * @modifications 重写并实现了 sha224 函数，引用请注明出处。修改日期：2024-12-04，Github：cmliu
 */function sha224(t){const e=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298];function 右旋转(t,e){return(t>>>e|t<<32-e)>>>0}const n=function(t){let n=[3238371032,914150663,812702999,4144912697,4290775857,1750603025,1694076839,3204075428];const s=8*t.length;for(t+=String.fromCharCode(128);8*t.length%512!=448;)t+=String.fromCharCode(0);const o=Math.floor(s/4294967296),r=4294967295&s;t+=String.fromCharCode(o>>>24&255,o>>>16&255,o>>>8&255,255&o,r>>>24&255,r>>>16&255,r>>>8&255,255&r);const a=[];for(let e=0;e<t.length;e+=4)a.push(t.charCodeAt(e)<<24|t.charCodeAt(e+1)<<16|t.charCodeAt(e+2)<<8|t.charCodeAt(e+3));for(let t=0;t<a.length;t+=16){const s=new Array(64).fill(0);for(let e=0;e<16;e++)s[e]=a[t+e];for(let t=16;t<64;t++){const e=右旋转(s[t-15],7)^右旋转(s[t-15],18)^s[t-15]>>>3,n=右旋转(s[t-2],17)^右旋转(s[t-2],19)^s[t-2]>>>10;s[t]=s[t-16]+e+s[t-7]+n>>>0}let[o,r,l,i,c,d,p,u]=n;for(let t=0;t<64;t++){const n=u+(右旋转(c,6)^右旋转(c,11)^右旋转(c,25))+(c&d^~c&p)+e[t]+s[t]>>>0,a=o&r^o&l^r&l;u=p,p=d,d=c,c=i+n>>>0,i=l,l=r,r=o,o=n+((右旋转(o,2)^右旋转(o,13)^右旋转(o,22))+a>>>0)>>>0}n[0]=n[0]+o>>>0,n[1]=n[1]+r>>>0,n[2]=n[2]+l>>>0,n[3]=n[3]+i>>>0,n[4]=n[4]+c>>>0,n[5]=n[5]+d>>>0,n[6]=n[6]+p>>>0,n[7]=n[7]+u>>>0}return n.slice(0,7)}(unescape(encodeURIComponent(t)));return function(t){let e="";for(let n=0;n<t.length;n++)e+=(t[n]>>>4&15).toString(16),e+=(15&t[n]).toString(16);return e}(n.flatMap((t=>[t>>>24&255,t>>>16&255,t>>>8&255,255&t])))}async function 迁移地址列表(t,e="ADD.txt"){const n=await t.KV.get(`/${e}`),s=await t.KV.get(e);return!(!n||s)&&(await t.KV.put(e,n),await t.KV.delete(`/${e}`),!0)}async function KV(t,e,n="ADD.txt"){try{if("POST"===t.method){if(!e.KV)return new Response("未绑定KV空间",{status:400});try{const s=await t.text();return await e.KV.put(n,s),new Response("保存成功")}catch(t){return console.error("保存KV时发生错误:",t),new Response("保存失败: "+t.message,{status:500})}}let s="",o=!!e.KV;if(o)try{s=await e.KV.get(n)||""}catch(t){console.error("读取KV时发生错误:",t),s="读取数据时发生错误: "+t.message}const r=`\n\t\t\t<!DOCTYPE html>\n\t\t\t<html>\n\t\t\t<head>\n\t\t\t\t<title>优选订阅列表</title>\n\t\t\t\t<meta charset="utf-8">\n\t\t\t\t<meta name="viewport" content="width=device-width, initial-scale=1">\n\t\t\t\t<style>\n\t\t\t\t\tbody {\n\t\t\t\t\t\tmargin: 0;\n\t\t\t\t\t\tpadding: 15px; /* 调整padding */\n\t\t\t\t\t\tbox-sizing: border-box;\n\t\t\t\t\t\tfont-size: 13px; /* 设置全局字体大小 */\n\t\t\t\t\t}\n\t\t\t\t\t.editor-container {\n\t\t\t\t\t\twidth: 100%;\n\t\t\t\t\t\tmax-width: 100%;\n\t\t\t\t\t\tmargin: 0 auto;\n\t\t\t\t\t}\n\t\t\t\t\t.editor {\n\t\t\t\t\t\twidth: 100%;\n\t\t\t\t\t\theight: 520px; /* 调整高度 */\n\t\t\t\t\t\tmargin: 15px 0; /* 调整margin */\n\t\t\t\t\t\tpadding: 10px; /* 调整padding */\n\t\t\t\t\t\tbox-sizing: border-box;\n\t\t\t\t\t\tborder: 1px solid #ccc;\n\t\t\t\t\t\tborder-radius: 4px;\n\t\t\t\t\t\tfont-size: 13px;\n\t\t\t\t\t\tline-height: 1.5;\n\t\t\t\t\t\toverflow-y: auto;\n\t\t\t\t\t\tresize: none;\n\t\t\t\t\t}\n\t\t\t\t\t.save-container {\n\t\t\t\t\t\tmargin-top: 8px; /* 调整margin */\n\t\t\t\t\t\tdisplay: flex;\n\t\t\t\t\t\talign-items: center;\n\t\t\t\t\t\tgap: 10px; /* 调整gap */\n\t\t\t\t\t}\n\t\t\t\t\t.save-btn, .back-btn {\n\t\t\t\t\t\tpadding: 6px 15px; /* 调整padding */\n\t\t\t\t\t\tcolor: white;\n\t\t\t\t\t\tborder: none;\n\t\t\t\t\t\tborder-radius: 4px;\n\t\t\t\t\t\tcursor: pointer;\n\t\t\t\t\t}\n\t\t\t\t\t.save-btn {\n\t\t\t\t\t\tbackground: #4CAF50;\n\t\t\t\t\t}\n\t\t\t\t\t.save-btn:hover {\n\t\t\t\t\t\tbackground: #45a049;\n\t\t\t\t\t}\n\t\t\t\t\t.back-btn {\n\t\t\t\t\t\tbackground: #666;\n\t\t\t\t\t}\n\t\t\t\t\t.back-btn:hover {\n\t\t\t\t\t\tbackground: #555;\n\t\t\t\t\t}\n\t\t\t\t\t.save-status {\n\t\t\t\t\t\tcolor: #666;\n\t\t\t\t\t}\n\t\t\t\t\t.notice-content {\n\t\t\t\t\t\tdisplay: none;\n\t\t\t\t\t\tmargin-top: 10px;\n\t\t\t\t\t\tfont-size: 13px;\n\t\t\t\t\t\tcolor: #333;\n\t\t\t\t\t}\n\t\t\t\t</style>\n\t\t\t</head>\n\t\t\t<body>\n\t\t\t\t################################################################<br>\n\t\t\t\t${FileName} 优选订阅列表:<br>\n\t\t\t\t---------------------------------------------------------------<br>\n\t\t\t\t&nbsp;&nbsp;<strong><a href="javascript:void(0);" id="noticeToggle" onclick="toggleNotice()">注意事项∨</a></strong><br>\n\t\t\t\t<div id="noticeContent" class="notice-content">\n\t\t\t\t\t${decodeURIComponent(atob("JTA5JTA5JTA5JTA5JTA5JTNDc3Ryb25nJTNFMS4lM0MlMkZzdHJvbmclM0UlMjBBRERBUEklMjAlRTUlQTYlODIlRTYlOUUlOUMlRTYlOTglQUYlRTUlOEYlOEQlRTQlQkIlQTNJUCVFRiVCQyU4QyVFNSU4RiVBRiVFNCVCRCU5QyVFNCVCOCVCQVBST1hZSVAlRTclOUElODQlRTglQUYlOUQlRUYlQkMlOEMlRTUlOEYlQUYlRTUlQjAlODYlMjIlM0Zwcm94eWlwJTNEdHJ1ZSUyMiVFNSU4RiU4MiVFNiU5NSVCMCVFNiVCNyVCQiVFNSU4QSVBMCVFNSU4OCVCMCVFOSU5MyVCRSVFNiU4RSVBNSVFNiU5QyVBQiVFNSVCMCVCRSVFRiVCQyU4QyVFNCVCRSU4QiVFNSVBNiU4MiVFRiVCQyU5QSUzQ2JyJTNFCiUwOSUwOSUwOSUwOSUwOSUyNm5ic3AlM0IlMjZuYnNwJTNCaHR0cHMlM0ElMkYlMkZyYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tJTJGY21saXUlMkZXb3JrZXJWbGVzczJzdWIlMkZtYWluJTJGYWRkcmVzc2VzYXBpLnR4dCUzQ3N0cm9uZyUzRSUzRnByb3h5aXAlM0R0cnVlJTNDJTJGc3Ryb25nJTNFJTNDYnIlM0UlM0NiciUzRQolMDklMDklMDklMDklMDklM0NzdHJvbmclM0UyLiUzQyUyRnN0cm9uZyUzRSUyMEFEREFQSSUyMCVFNSVBNiU4MiVFNiU5RSU5QyVFNiU5OCVBRiUyMCUzQ2ElMjBocmVmJTNEJTI3aHR0cHMlM0ElMkYlMkZnaXRodWIuY29tJTJGWElVMiUyRkNsb3VkZmxhcmVTcGVlZFRlc3QlMjclM0VDbG91ZGZsYXJlU3BlZWRUZXN0JTNDJTJGYSUzRSUyMCVFNyU5QSU4NCUyMGNzdiUyMCVFNyVCQiU5MyVFNiU5RSU5QyVFNiU5NiU4NyVFNCVCQiVCNiVFRiVCQyU4QyVFNCVCRSU4QiVFNSVBNiU4MiVFRiVCQyU5QSUzQ2JyJTNFCiUwOSUwOSUwOSUwOSUwOSUyNm5ic3AlM0IlMjZuYnNwJTNCaHR0cHMlM0ElMkYlMkZyYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tJTJGY21saXUlMkZXb3JrZXJWbGVzczJzdWIlMkZtYWluJTJGQ2xvdWRmbGFyZVNwZWVkVGVzdC5jc3YlM0NiciUzRSUzQ2JyJTNFCiUwOSUwOSUwOSUwOSUwOSUyNm5ic3AlM0IlMjZuYnNwJTNCLSUyMCVFNSVBNiU4MiVFOSU5QyU4MCVFNiU4QyU4NyVFNSVBRSU5QTIwNTMlRTclQUIlQUYlRTUlOEYlQTMlRTUlOEYlQUYlRTUlQjAlODYlMjIlM0Zwb3J0JTNEMjA1MyUyMiVFNSU4RiU4MiVFNiU5NSVCMCVFNiVCNyVCQiVFNSU4QSVBMCVFNSU4OCVCMCVFOSU5MyVCRSVFNiU4RSVBNSVFNiU5QyVBQiVFNSVCMCVCRSVFRiVCQyU4QyVFNCVCRSU4QiVFNSVBNiU4MiVFRiVCQyU5QSUzQ2JyJTNFCiUwOSUwOSUwOSUwOSUwOSUyNm5ic3AlM0IlMjZuYnNwJTNCaHR0cHMlM0ElMkYlMkZyYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tJTJGY21saXUlMkZXb3JrZXJWbGVzczJzdWIlMkZtYWluJTJGQ2xvdWRmbGFyZVNwZWVkVGVzdC5jc3YlM0NzdHJvbmclM0UlM0Zwb3J0JTNEMjA1MyUzQyUyRnN0cm9uZyUzRSUzQ2JyJTNFJTNDYnIlM0UKJTA5JTA5JTA5JTA5JTA5JTI2bmJzcCUzQiUyNm5ic3AlM0ItJTIwJUU1JUE2JTgyJUU5JTlDJTgwJUU2JThDJTg3JUU1JUFFJTlBJUU4JThBJTgyJUU3JTgyJUI5JUU1JUE0JTg3JUU2JUIzJUE4JUU1JThGJUFGJUU1JUIwJTg2JTIyJTNGaWQlM0RDRiVFNCVCQyU5OCVFOSU4MCU4OSUyMiVFNSU4RiU4MiVFNiU5NSVCMCVFNiVCNyVCQiVFNSU4QSVBMCVFNSU4OCVCMCVFOSU5MyVCRSVFNiU4RSVBNSVFNiU5QyVBQiVFNSVCMCVCRSVFRiVCQyU4QyVFNCVCRSU4QiVFNSVBNiU4MiVFRiVCQyU5QSUzQ2JyJTNFCiUwOSUwOSUwOSUwOSUwOSUyNm5ic3AlM0IlMjZuYnNwJTNCaHR0cHMlM0ElMkYlMkZyYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tJTJGY21saXUlMkZXb3JrZXJWbGVzczJzdWIlMkZtYWluJTJGQ2xvdWRmbGFyZVNwZWVkVGVzdC5jc3YlM0NzdHJvbmclM0UlM0ZpZCUzRENGJUU0JUJDJTk4JUU5JTgwJTg5JTNDJTJGc3Ryb25nJTNFJTNDYnIlM0UlM0NiciUzRQolMDklMDklMDklMDklMDklMjZuYnNwJTNCJTI2bmJzcCUzQi0lMjAlRTUlQTYlODIlRTklOUMlODAlRTYlOEMlODclRTUlQUUlOUElRTUlQTQlOUElRTQlQjglQUElRTUlOEYlODIlRTYlOTUlQjAlRTUlODglOTklRTklOUMlODAlRTglQTYlODElRTQlQkQlQkYlRTclOTQlQTglMjclMjYlMjclRTUlODElOUElRTklOTclQjQlRTklOUElOTQlRUYlQkMlOEMlRTQlQkUlOEIlRTUlQTYlODIlRUYlQkMlOUElM0NiciUzRQolMDklMDklMDklMDklMDklMjZuYnNwJTNCJTI2bmJzcCUzQmh0dHBzJTNBJTJGJTJGcmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSUyRmNtbGl1JTJGV29ya2VyVmxlc3Myc3ViJTJGbWFpbiUyRkNsb3VkZmxhcmVTcGVlZFRlc3QuY3N2JTNGaWQlM0RDRiVFNCVCQyU5OCVFOSU4MCU4OSUzQ3N0cm9uZyUzRSUyNiUzQyUyRnN0cm9uZyUzRXBvcnQlM0QyMDUzJTNDYnIlM0U="))}\n\t\t\t\t</div>\n\t\t\t\t<div class="editor-container">\n\t\t\t\t\t${o?`\n\t\t\t\t\t<textarea class="editor" \n\t\t\t\t\t\tplaceholder="${decodeURIComponent(atob("QUREJUU3JUE0JUJBJUU0JUJFJThCJUVGJUJDJTlBCnZpc2EuY24lMjMlRTQlQkMlOTglRTklODAlODklRTUlOUYlOUYlRTUlOTAlOEQKMTI3LjAuMC4xJTNBMTIzNCUyM0NGbmF0CiU1QjI2MDYlM0E0NzAwJTNBJTNBJTVEJTNBMjA1MyUyM0lQdjYKCiVFNiVCMyVBOCVFNiU4NCU4RiVFRiVCQyU5QQolRTYlQUYlOEYlRTglQTElOEMlRTQlQjglODAlRTQlQjglQUElRTUlOUMlQjAlRTUlOUQlODAlRUYlQkMlOEMlRTYlQTAlQkMlRTUlQkMlOEYlRTQlQjglQkElMjAlRTUlOUMlQjAlRTUlOUQlODAlM0ElRTclQUIlQUYlRTUlOEYlQTMlMjMlRTUlQTQlODclRTYlQjMlQTgKSVB2NiVFNSU5QyVCMCVFNSU5RCU4MCVFOSU5QyU4MCVFOCVBNiU4MSVFNyU5NCVBOCVFNCVCOCVBRCVFNiU4QiVBQyVFNSU4RiVCNyVFNiU4QiVBQyVFOCVCNSVCNyVFNiU5RCVBNSVFRiVCQyU4QyVFNSVBNiU4MiVFRiVCQyU5QSU1QjI2MDYlM0E0NzAwJTNBJTNBJTVEJTNBMjA1MwolRTclQUIlQUYlRTUlOEYlQTMlRTQlQjglOEQlRTUlODYlOTklRUYlQkMlOEMlRTklQkIlOTglRTglQUUlQTQlRTQlQjglQkElMjA0NDMlMjAlRTclQUIlQUYlRTUlOEYlQTMlRUYlQkMlOEMlRTUlQTYlODIlRUYlQkMlOUF2aXNhLmNuJTIzJUU0JUJDJTk4JUU5JTgwJTg5JUU1JTlGJTlGJUU1JTkwJThECgoKQUREQVBJJUU3JUE0JUJBJUU0JUJFJThCJUVGJUJDJTlBCmh0dHBzJTNBJTJGJTJGcmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSUyRmNtbGl1JTJGV29ya2VyVmxlc3Myc3ViJTJGcmVmcyUyRmhlYWRzJTJGbWFpbiUyRmFkZHJlc3Nlc2FwaS50eHQKCiVFNiVCMyVBOCVFNiU4NCU4RiVFRiVCQyU5QUFEREFQSSVFNyU5QiVCNCVFNiU4RSVBNSVFNiVCNyVCQiVFNSU4QSVBMCVFNyU5QiVCNCVFOSU5MyVCRSVFNSU4RCVCMyVFNSU4RiVBRg=="))}"\n\t\t\t\t\t\tid="content">${s}</textarea>\n\t\t\t\t\t<div class="save-container">\n\t\t\t\t\t\t<button class="back-btn" onclick="goBack()">返回配置页</button>\n\t\t\t\t\t\t<button class="save-btn" onclick="saveContent(this)">保存</button>\n\t\t\t\t\t\t<span class="save-status" id="saveStatus"></span>\n\t\t\t\t\t</div>\n\t\t\t\t\t<br>\n\t\t\t\t\t################################################################<br>\n\t\t\t\t\t${cmad}\n\t\t\t\t\t`:"<p>未绑定KV空间</p>"}\n\t\t\t\t</div>\n\t\t\n\t\t\t\t<script>\n\t\t\t\tif (document.querySelector('.editor')) {\n\t\t\t\t\tlet timer;\n\t\t\t\t\tconst textarea = document.getElementById('content');\n\t\t\t\t\tconst originalContent = textarea.value;\n\t\t\n\t\t\t\t\tfunction goBack() {\n\t\t\t\t\t\tconst currentUrl = window.location.href;\n\t\t\t\t\t\tconst parentUrl = currentUrl.substring(0, currentUrl.lastIndexOf('/'));\n\t\t\t\t\t\twindow.location.href = parentUrl;\n\t\t\t\t\t}\n\t\t\n\t\t\t\t\tfunction replaceFullwidthColon() {\n\t\t\t\t\t\tconst text = textarea.value;\n\t\t\t\t\t\ttextarea.value = text.replace(/：/g, ':');\n\t\t\t\t\t}\n\t\t\t\t\t\n\t\t\t\t\tfunction saveContent(button) {\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tconst updateButtonText = (step) => {\n\t\t\t\t\t\t\t\tbutton.textContent = \`保存中: \${step}\`;\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t// 检测是否为iOS设备\n\t\t\t\t\t\t\tconst isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t// 仅在非iOS设备上执行replaceFullwidthColon\n\t\t\t\t\t\t\tif (!isIOS) {\n\t\t\t\t\t\t\t\treplaceFullwidthColon();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tupdateButtonText('开始保存');\n\t\t\t\t\t\t\tbutton.disabled = true;\n\t\t\t\t\t\t\t// 获取textarea内容和原始内容\n\t\t\t\t\t\t\tconst textarea = document.getElementById('content');\n\t\t\t\t\t\t\tif (!textarea) {\n\t\t\t\t\t\t\t\tthrow new Error('找不到文本编辑区域');\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tupdateButtonText('获取内容');\n\t\t\t\t\t\t\tlet newContent;\n\t\t\t\t\t\t\tlet originalContent;\n\t\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\t\tnewContent = textarea.value || '';\n\t\t\t\t\t\t\t\toriginalContent = textarea.defaultValue || '';\n\t\t\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\t\t\tconsole.error('获取内容错误:', e);\n\t\t\t\t\t\t\t\tthrow new Error('无法获取编辑内容');\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tupdateButtonText('准备状态更新函数');\n\t\t\t\t\t\t\tconst updateStatus = (message, isError = false) => {\n\t\t\t\t\t\t\t\tconst statusElem = document.getElementById('saveStatus');\n\t\t\t\t\t\t\t\tif (statusElem) {\n\t\t\t\t\t\t\t\t\tstatusElem.textContent = message;\n\t\t\t\t\t\t\t\t\tstatusElem.style.color = isError ? 'red' : '#666';\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\tupdateButtonText('准备按钮重置函数');\n\t\t\t\t\t\t\tconst resetButton = () => {\n\t\t\t\t\t\t\t\tbutton.textContent = '保存';\n\t\t\t\t\t\t\t\tbutton.disabled = false;\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\tif (newContent !== originalContent) {\n\t\t\t\t\t\t\t\tupdateButtonText('发送保存请求');\n\t\t\t\t\t\t\t\tfetch(window.location.href, {\n\t\t\t\t\t\t\t\t\tmethod: 'POST',\n\t\t\t\t\t\t\t\t\tbody: newContent,\n\t\t\t\t\t\t\t\t\theaders: {\n\t\t\t\t\t\t\t\t\t\t'Content-Type': 'text/plain;charset=UTF-8'\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\tcache: 'no-cache'\n\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t.then(response => {\n\t\t\t\t\t\t\t\t\tupdateButtonText('检查响应状态');\n\t\t\t\t\t\t\t\t\tif (!response.ok) {\n\t\t\t\t\t\t\t\t\t\tthrow new Error(\`HTTP error! status: \${response.status}\`);\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\tupdateButtonText('更新保存状态');\n\t\t\t\t\t\t\t\t\tconst now = new Date().toLocaleString();\n\t\t\t\t\t\t\t\t\tdocument.title = \`编辑已保存 \${now}\`;\n\t\t\t\t\t\t\t\t\tupdateStatus(\`已保存 \${now}\`);\n\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t.catch(error => {\n\t\t\t\t\t\t\t\t\tupdateButtonText('处理错误');\n\t\t\t\t\t\t\t\t\tconsole.error('Save error:', error);\n\t\t\t\t\t\t\t\t\tupdateStatus(\`保存失败: \${error.message}\`, true);\n\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t.finally(() => {\n\t\t\t\t\t\t\t\t\tresetButton();\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tupdateButtonText('检查内容变化');\n\t\t\t\t\t\t\t\tupdateStatus('内容未变化');\n\t\t\t\t\t\t\t\tresetButton();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} catch (error) {\n\t\t\t\t\t\t\tconsole.error('保存过程出错:', error);\n\t\t\t\t\t\t\tbutton.textContent = '保存';\n\t\t\t\t\t\t\tbutton.disabled = false;\n\t\t\t\t\t\t\tconst statusElem = document.getElementById('saveStatus');\n\t\t\t\t\t\t\tif (statusElem) {\n\t\t\t\t\t\t\t\tstatusElem.textContent = \`错误: \${error.message}\`;\n\t\t\t\t\t\t\t\tstatusElem.style.color = 'red';\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\n\t\t\t\t\ttextarea.addEventListener('blur', saveContent);\n\t\t\t\t\ttextarea.addEventListener('input', () => {\n\t\t\t\t\t\tclearTimeout(timer);\n\t\t\t\t\t\ttimer = setTimeout(saveContent, 5000);\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\n\t\t\t\tfunction toggleNotice() {\n\t\t\t\t\tconst noticeContent = document.getElementById('noticeContent');\n\t\t\t\t\tconst noticeToggle = document.getElementById('noticeToggle');\n\t\t\t\t\tif (noticeContent.style.display === 'none' || noticeContent.style.display === '') {\n\t\t\t\t\t\tnoticeContent.style.display = 'block';\n\t\t\t\t\t\tnoticeToggle.textContent = '注意事项∧';\n\t\t\t\t\t} else {\n\t\t\t\t\t\tnoticeContent.style.display = 'none';\n\t\t\t\t\t\tnoticeToggle.textContent = '注意事项∨';\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\n\t\t\t\t// 初始化 noticeContent 的 display 属性\n\t\t\t\tdocument.addEventListener('DOMContentLoaded', () => {\n\t\t\t\t\tdocument.getElementById('noticeContent').style.display = 'none';\n\t\t\t\t});\n\t\t\t\t<\/script>\n\t\t\t</body>\n\t\t\t</html>\n\t\t`;return new Response(r,{headers:{"Content-Type":"text/html;charset=utf-8"}})}catch(t){return console.error("处理请求时发生错误:",t),new Response("服务器错误: "+t.message,{status:500,headers:{"Content-Type":"text/plain;charset=utf-8"}})}}
